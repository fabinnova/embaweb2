<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#222" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" sizes="180x180" href="./img/icons/apple-touch-icon.png">
    <link rel="mask-icon" href="./img/icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="manifest" href="./manifest.json">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/1d874cc34d.js" crossorigin="anonymous"></script>
    <title>Innova</title>
    <link rel="stylesheet" href='./main.css'>
</head>
<body>
   <div class="completeCenter" id="centralSpinner">
    <div class="spinner-border"></div>
   </div>

  <div class="container hidden" id="mainContainer">
    <!--MACCHINA START-->
        <div class="row">
          <div class="col-12 p-0">
            <div class="text-center bg-secondary text-light m-1 p-3 cartTitle">ONDULATORE</div>  
          </div>
         
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue " id="Ondu1ProduzioneOk"></div>
            </div>  
          </div>
          <div class="col-6 p-0 ">
            <div class="text-center bg-light m-1 p-2 row minHeight">
            </div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue" id="Ondu1Prod"></div>
              <div class="col-12 cardValueLegendSmall">Produzione (m/lin)</div>
            </div>  
          </div>
          
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue " id="Ondu1AvgSpeed"></div>
              <div class="col-12 cardValueLegendSmall">Vm (m/min)</div>
            </div>  
          </div>
          
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue text-danger" id="Ondu1Fermo"></div>
              <div class="col-12 cardValueLegendSmall">Fermo (min)</div>
            </div>  
          </div>
          
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue " id="Ondu1Speed"></div>
              <div class="col-12 cardValueLegendSmall">V (m/min)</div>
            </div>  
          </div>

          <div class="col-12 p-0">
            <div class="text-center bg-light text-black m-1 p-0 cardValueLegendSmall" id="Ondu1LastUp"></div>  
          </div>
        </div>
    <!--MACCHINA END-->
    <!--MACCHINA START-->
        <div class="row mt-3">
          <div class="col-12 p-0">
            <div class="text-center bg-secondary text-light m-1 p-3 cartTitle" id="emba6Title"></div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue " id="emba6ProduzioneOk"></div>
            </div>  
          </div>
          <div class="col-6 p-0 ">
            <div class="text-center bg-light m-1 p-2 row minHeight">
              <div class="col-12 cardValue " id="emba6FermoSetup"></div>
            </div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue" id="emba6MqTot"></div>
              <div class="col-12 cardValueLegendSmall">Mq Tot.</div>
            </div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue " id="emba6MqH"></div>
              <div class="col-12 cardValueLegendSmall">Mq/h</div>
            </div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue text-danger" id="emba6FermoTot"></div>
              <div class="col-12 cardValueLegendSmall">Fermo Tot.</div>
            </div>  
          </div>
          <div class="col-6 p-0">
            <div class="text-center bg-light m-1 p-2 row">
              <div class="col-12 cardValue text-danger" id="emba6FermoCom"></div>
              <div class="col-12 cardValueLegendSmall">Fermo Comm.</div>
            </div>  
          </div>
          <div class="col-12 p-0">
            <div class="text-center bg-light text-black m-1 p-0 cardValueLegendSmall" id="emba6UltimoUp"></div>  
          </div>
        </div>
    <!--MACCHINA END-->

    <!--MACCHINA START-->
    <div class="row mt-3">
      <div class="col-12 p-0">
        <div class="text-center bg-secondary text-light m-1 p-3 cartTitle" id="emba5Title"></div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue " id="emba5ProduzioneOk"></div>
        </div>  
      </div>
      <div class="col-6 p-0 ">
        <div class="text-center bg-light m-1 p-2 row minHeight">
          <div class="col-12 cardValue " id="emba5FermoSetup"></div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue" id="emba5MqTot"></div>
          <div class="col-12 cardValueLegendSmall">Mq Tot.</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue " id="emba5MqH"></div>
          <div class="col-12 cardValueLegendSmall">Mq/h</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue text-danger" id="emba5FermoTot"></div>
          <div class="col-12 cardValueLegendSmall">Fermo Tot.</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue text-danger" id="emba5FermoCom"></div>
          <div class="col-12 cardValueLegendSmall">Fermo Comm.</div>
        </div>  
      </div>
      <div class="col-12 p-0">
        <div class="text-center bg-light text-black m-1 p-0 cardValueLegendSmall" id="emba5UltimoUp"></div>  
      </div>
    </div>
<!--MACCHINA END-->


    <!--MACCHINA START-->
    <div class="row mt-3">
      <div class="col-12 p-0">
        <div class="text-center bg-secondary text-light m-1 p-3 cartTitle" id="emba4Title"></div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue " id="emba4ProduzioneOk"></div>
        </div>  
      </div>
      <div class="col-6 p-0 ">
        <div class="text-center bg-light m-1 p-2 row minHeight">
          <div class="col-12 cardValue " id="emba4FermoSetup"></div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue" id="emba4MqTot"></div>
          <div class="col-12 cardValueLegendSmall">Mq Tot.</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue " id="emba4MqH"></div>
          <div class="col-12 cardValueLegendSmall">Mq/h</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue text-danger" id="emba4FermoTot"></div>
          <div class="col-12 cardValueLegendSmall">Fermo Tot.</div>
        </div>  
      </div>
      <div class="col-6 p-0">
        <div class="text-center bg-light m-1 p-2 row">
          <div class="col-12 cardValue text-danger" id="emba4FermoCom"></div>
          <div class="col-12 cardValueLegendSmall">Fermo Comm.</div>
        </div>  
      </div>
      <div class="col-12 p-0">
        <div class="text-center bg-light text-black m-1 p-0 cardValueLegendSmall" id="emba4UltimoUp"></div>  
      </div>
    </div>
<!--MACCHINA END-->

<div class="py-1"></div>

<div id="installContainer" class="hidden" >
  
  <a class="close" id="buttonClose" ></a>
  <button id="buttonInstall" type="button">
    Aggiungi a schermata Home
  </button>
</div>
</div>

   
<script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-database.js"></script>
<script>
    var firebaseConfig = {
      apiKey: "AIzaSyCZky8lzCTdXM6qBauiRfQ41zrZ3EPNiaQ",
      authDomain: "embaweb-c4ec8.firebaseapp.com",
      databaseURL: "https://embaweb-c4ec8.firebaseio.com",
      projectId: "embaweb-c4ec8",
      storageBucket: "embaweb-c4ec8.appspot.com",
      messagingSenderId: "342536773221",
      appId: "1:342536773221:web:eb12ff5ec0b664d425308c"
    };
    firebase.initializeApp(firebaseConfig);
  
    // Get a reference to the database service
    var database = firebase.database();
    var embas = [ ['4',  6600], ['5', 4000], ['6', 6000] ];
    embas.forEach(e => {
      var emba = firebase.database().ref('Emba/Emba' + e[0]);
      emba.on('value', function(snapshot) {
          var data = snapshot.val();
          handleEmba(e[0], e[1], data);
      });
    });
    
    var ondu = firebase.database().ref('Ondu/Ondu1');
    ondu.on('value', function(snapshot) {
        var data = snapshot.val();
        handleOndu(data);
    });

    var qtaCommessaAttualeLast = {}
    function handleEmba(embaId, embaMqhTH, embaData) {
      
      document.getElementById(`emba${embaId}Title`).innerHTML = embaData.risorsa;
      document.getElementById(`emba${embaId}MqTot`).innerHTML = numberWithCommas(embaData.mqProdottiDaInizioTurno);
      document.getElementById(`emba${embaId}FermoTot`).innerHTML = embaData.minutiFermoDaInizioTurno;
      document.getElementById(`emba${embaId}FermoCom`).innerHTML = embaData.minutiFermoCommessaAttuale;
      document.getElementById(`emba${embaId}UltimoUp`).innerHTML = (new Date(embaData.instant)).toLocaleTimeString();

      var mqtH =  document.getElementById(`emba${embaId}MqH`);
      if(embaData.mqOraDaInizioTurno >= embaMqhTH) {
        mqtH.classList.remove('text-danger');
        mqtH.classList.add('text-success');
      } else {
        mqtH.classList.remove('text-success');
        mqtH.classList.add('text-danger');
      }
      mqtH.innerHTML = numberWithCommas(embaData.mqOraDaInizioTurno);
      
      var embaFermoSetup = document.getElementById(`emba${embaId}FermoSetup`);
      
      if(embaData.inSetup) {
        embaFermoSetup.innerHTML = '<i class="col-12 fas fa-cog fa-lg text-warning"></i>';
      } else if(embaData.inFermo) {
        embaFermoSetup.innerHTML = '<i class="fas fa-exclamation-triangle fa-lg text-danger"></i>';
      } else {
        embaFermoSetup.innerHTML = "";
      }
      
      
      if(  embaData.qtaCommessaAttuale > qtaCommessaAttualeLast[embaId] || (embaData.qtaCommessaAttuale > 0 && qtaCommessaAttualeLast[embaId]==undefined) ) {
        document.getElementById(`emba${embaId}ProduzioneOk`).innerHTML = '<i class="fas fa-circle fa-lg text-success"></i>';
      } else {
        document.getElementById(`emba${embaId}ProduzioneOk`).innerHTML = '<i class="fas fa-circle fa-lg text-danger"></i>';
      }
      qtaCommessaAttualeLast[embaId] = embaData.qtaCommessaAttuale;
      
    }

    var onduTotaleProdLast = -1;
    var noGoodTimes = 0;
    const speedLevels = [200, 240];
    function handleOndu(data) {
      if(data!=undefined && data.speed!=undefined
      && data.avgSpeed != undefined && data.stop!=undefined
       && data.meters != undefined) {

          document.getElementById(`Ondu1Speed`).innerHTML = data.speed;
          // document.getElementById(`Ondu1AvgSpeed`).innerHTML = data.avgSpeed;
          document.getElementById(`Ondu1Fermo`).innerHTML = data.stop;
          document.getElementById(`Ondu1Prod`).innerHTML = numberWithCommas(data.meters);
          document.getElementById('Ondu1LastUp').innerHTML =  (new Date(data.timestamp)).toLocaleTimeString(); 

         var avgSp =  document.getElementById(`Ondu1AvgSpeed`);
         
         if( data.avgSpeed >= speedLevels[1] ) {
           avgSp.classList.remove('text-warning');
           avgSp.classList.remove('text-danger');
           avgSp.classList.add('text-success');
         } else if(data.avgSpeed >= speedLevels[0]) {
           avgSp.classList.remove('text-success');
           avgSp.classList.remove('text-danger');
           avgSp.classList.add('text-warning');
         } else {
           avgSp.classList.remove('text-success');
           avgSp.classList.remove('text-warning');
           avgSp.classList.add('text-danger');
         }
   
         avgSp.innerHTML = data.avgSpeed;
         

         if( data.meters == onduTotaleProdLast && noGoodTimes >= 4) {
           document.getElementById(`Ondu1ProduzioneOk`).innerHTML = '<i class="fas fa-circle fa-lg text-danger"></i>';
         } else if(data.meters == onduTotaleProdLast) {
          document.getElementById(`Ondu1ProduzioneOk`).innerHTML = '<i class="fas fa-circle fa-lg text-success"></i>';
          noGoodTimes += 1;
         } else {
           document.getElementById(`Ondu1ProduzioneOk`).innerHTML = '<i class="fas fa-circle fa-lg text-success"></i>';
           noGoodTimes = 0;
         }
         onduTotaleProdLast = data.meters;

       }
       
    }
    
    window.addEventListener('load', e => {
      registerSW(); 
    });
    async function registerSW() { 
      if ('serviceWorker' in navigator) { 
        try {
          await navigator.serviceWorker.register('./sw.js'); 
        } catch (e) {
          alert('ServiceWorker registration failed. Sorry about that.'); 
        }
      } else {
        document.querySelector('.alert').removeAttribute('hidden'); 
      }
    }

    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      deferredPrompt = e;
      // Update UI notify the user they can install the PWA
      showInstallPromotion();
    });

    buttonInstall.addEventListener('click', (e) => {
      // Hide the app provided install promotion
      hideMyInstallPromotion();
      
      // Show the install prompt
      deferredPrompt.prompt();
      // Wait for the user to respond to the prompt
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
      })
    });

    function showInstallPromotion() {
      installContainer.classList.remove('hidden');
    }
    function hideMyInstallPromotion() {
      installContainer.classList.add('hidden');
    }

    buttonClose.addEventListener('click', (e) => {
      installContainer.classList.add('hidden');
    });

    // const isIos = () => {
    //   const userAgent = window.navigator.userAgent.toLowerCase();
    //   return /iphone|ipad|ipod/.test( userAgent );
    // }
    // // Detects if device is in standalone mode
    // const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

    // // Checks if should display install popup notification:
    // if (isIos() && !isInStandaloneMode()) {
    //   console.log('ios');
    // }
    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    setTimeout(() => {
      centralSpinner.classList.add('hidden');
      mainContainer.classList.remove('hidden');
    }, 2000);
</script>
</body>
</html>